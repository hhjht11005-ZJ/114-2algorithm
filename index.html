<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼”ç®—æ³•ç‰¹å‹™å­¸é™¢ (v4 - æš«åœä¿®å¾©/æ›´å¤šç¯„ä¾‹)</title>
    <style>
        /* --- å…¨å±€æ¨£å¼ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f0f4f8;
            color: #333;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* --- æ¨™é¡Œæ¬„ --- */
        header {
            background: linear-gradient(135deg, #4a90e2, #50e3c2);
            color: white;
            padding: 20px 40px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-bottom: 5px solid #43a047;
        }
        header h1 { margin: 0; font-size: 2.5rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        header p { margin: 5px 0 0; font-size: 1.2rem; opacity: 0.9; }

        /* --- ä¸»å…§å®¹å€ --- */
        main { max-width: 900px; margin: 30px auto; padding: 20px; }

        /* --- ä»»å‹™å¡ç‰‡æ¨£å¼ --- */
        .mission {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            padding: 25px 30px;
            border: 1px solid #e0e0e0;
            display: none; /* é è¨­éš±è—æ‰€æœ‰ä»»å‹™ */
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .mission h2 {
            color: #4a90e2;
            border-bottom: 2px solid #f0f4f8;
            padding-bottom: 10px;
            font-size: 2rem;
            margin-top: 0;
        }
        .mission h2 span {
            font-size: 1rem;
            color: #777;
            font-weight: normal;
            margin-left: 10px;
            background: #eee;
            padding: 3px 8px;
            border-radius: 5px;
        }
        .mission-intro {
            font-size: 1.1rem;
            background: #f9f9f9;
            border-left: 5px solid #50e3c2;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        /* --- äº’å‹•æŒ‰éˆ• --- */
        .btn {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin: 5px; /* å¢åŠ é–“è· */
        }
        .btn:hover:not(:disabled) {
            background-color: #357ABD;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .btn-next { background-color: #4CAF50; }
        .btn-next:hover:not(:disabled) { background-color: #43a047; }
        .btn-check { background-color: #f39c12; }
        .btn-check:hover:not(:disabled) { background-color: #e67e22; }
        .btn-reset { background-color: #e74c3c; }
        .btn-reset:hover:not(:disabled) { background-color: #c0392b; }
        .btn-hint { background-color: #9b59b6; }
        .btn-hint:hover:not(:disabled) { background-color: #8e44ad; }
        .btn-pause { background-color: #3498db; }
        .btn-pause:hover:not(:disabled) { background-color: #2980b9; }

        /* --- ä»»å‹™1ï¼šæ‹–æ›³æ’åº --- */
        #drop-zone {
            background: #fdfdfd;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            margin: 20px 0;
        }
        .drag-item {
            background-color: #50e3c2;
            color: #333;
            padding: 10px 15px;
            margin: 10px;
            border-radius: 5px;
            cursor: move;
            text-align: center;
            font-weight: bold;
            border: 1px solid #43a047;
        }
        #item-pool {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            background: #f0f4f8;
            padding: 10px;
            border-radius: 8px;
        }
        .drag-item.hint-glow { animation: glow 1.5s infinite; }
        @keyframes glow {
            0% { box-shadow: 0 0 5px #9b59b6; }
            50% { box-shadow: 0 0 20px #9b59b6; }
            100% { box-shadow: 0 0 5px #9b59b6; }
        }

        /* --- ä»»å‹™2 & 3ï¼šè¦–è¦ºåŒ–æ–¹å¡Š --- */
        .data-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            flex-wrap: wrap;
        }
        .data-box {
            width: 60px;
            height: 60px;
            background: #e0e0e0;
            border: 1px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 8px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .data-box.highlight-min {
            background-color: #f39c12; /* æ©˜è‰² */
            color: white;
            border-color: #e67e22;
        }
        .data-box.highlight-swap {
            background-color: #e74c3c; /* ç´…è‰² */
            color: white;
            border-color: #c0392b;
        }
        .data-box.sorted {
            background-color: #4CAF50; /* ç¶ è‰² */
            color: white;
            border-color: #43a047;
        }
        .data-box.search-target { cursor: pointer; }
        .data-box.search-target:hover { transform: scale(1.1); }
        .data-box.disabled {
            background: #f5f5f5;
            color: #bbb;
            opacity: 0.6;
        }

        /* --- [v4 ç¢ºèª] Scratch ç©æœ¨æ¨£å¼ --- */
        .scratch-puzzle-container {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .scratch-stack {
            padding-left: 20px; /* æ¨¡æ“¬å †ç–Šç¸®æ’ */
        }
        .scratch-block {
            padding: 8px 12px;
            color: white;
            border-radius: 5px;
            margin-bottom: 5px;
            font-weight: bold;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            display: inline-block; /* è®“ç©æœ¨å¯¬åº¦è‡ªé©æ‡‰ */
            min-width: 40px;
            text-align: center;
        }
        .scratch-block-control { background-color: #ffab19; } /* æ§åˆ¶ (æ©˜è‰²) */
        .scratch-block-data { background-color: #ff8c1a; } /* è®Šæ•¸ (æ·±æ©˜) */
        .scratch-block-operator { background-color: #59c059; } /* é‹ç®— (ç¶ è‰²) */
        
        .scratch-inline-input {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 2px 8px;
            color: black;
            font-weight: normal;
            display: inline-block;
            min-width: 30px;
        }
        .scratch-quiz-select {
            font-size: 1rem;
            padding: 5px;
            border: 2px solid #4a90e2;
            border-radius: 5px;
            margin: 0 5px;
        }
        
        /* --- çµæœæç¤º --- */
        .feedback {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
        .feedback.success {
            background: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .feedback.error {
            background: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .feedback.hint {
            background: #fcf8e3;
            color: #8a6d3b;
            border: 1px solid #faebcc;
        }

        /* --- é è…³ --- */
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            background: #333;
            color: #aaa;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <header>
        <h1>ğŸ•µï¸ æ¼”ç®—æ³•ç‰¹å‹™å­¸é™¢ ğŸ•µï¸</h1>
        <p>ä½ çš„ä»»å‹™ï¼Œå°±æ˜¯å­¸æœƒå¦‚ä½•è°æ˜åœ°è§£æ±ºå•é¡Œï¼</p>
    </header>

    <main>

        <section id="mission-1" class="mission">
            <h2>Mission 1: ç‰¹å‹™çš„é£Ÿè­œ <span>(æ¼”ç®—æ³•åŸºç¤)</span></h2>
            <p class="mission-intro">
                <strong>æ•™å®˜ï¼š</strong> ã€Œæ¢å“¡ï¼Œæ­¡è¿ä¾†åˆ°å­¸é™¢ï¼æ¼”ç®—æ³•å°±æ˜¯ã€è§£æ±ºå•é¡Œçš„æ­¥é©Ÿã€ã€‚ä½ çš„ç¬¬ä¸€å€‹ä»»å‹™ï¼šæŒ‰ç…§ã€æ©Ÿå¯†é£Ÿè­œã€(è›‹ç‚’é£¯)çš„æ­£ç¢ºæ­¥é©Ÿï¼Œæº–å‚™ä½ çš„èƒ½é‡é¤ï¼ã€
            </p>
            <p><strong>ğŸ“– ä»»å‹™èªªæ˜ï¼š</strong> è«‹å°‡ä¸‹æ–¹çš„æ­¥é©Ÿæ‹–æ›³åˆ°ä¸Šæ–¹çš„ã€Œçƒ¹é£ªå€ã€ä¸­ï¼Œä¸¦æ’åˆ—æˆæ­£ç¢ºçš„é †åºã€‚</p>
            
            <div id="drop-zone" ondragover="event.preventDefault()" ondrop="m1_handleDrop(event)">
                </div>

            <div id="item-pool">
                <div class="drag-item" id="step-3" draggable="true" ondragstart="m1_handleDragStart(event)">é–‹ä¸­ç«ï¼ŒåŠ å…¥è›‹</div>
                <div class="drag-item" id="step-1" draggable="true" ondragstart="m1_handleDragStart(event)">æ”¾å…¥é©é‡çš„æ²¹è‡³é‹ä¸­</div>
                <div class="drag-item" id="step-5" draggable="true" ondragstart="m1_handleDragStart(event)">åŠ å…¥ç±³é£¯</div>
                <div class="drag-item" id="step-2" draggable="true" ondragstart="m1_handleDragStart(event)">åŠ ç†± (ç›´åˆ°æ²¹ç†±äº†)</div>
                <div class="drag-item" id="step-7" draggable="true" ondragstart="m1_handleDragStart(event)">åŠ å…¥èª¿å‘³æ–™æ‹Œå‹»</div>
                <div class="drag-item" id="step-4" draggable="true" ondragstart="m1_handleDragStart(event)">å¿«é€Ÿæ”ªæ‹Œ (ç›´åˆ°è›‹å‡å›º)</div>
                <div class="drag-item" id="step-6" draggable="true" ondragstart="m1_handleDragStart(event)">ç¿»ç‚’ (ç›´åˆ°ç±³é£¯æ•£é–‹)</div>
            </div>

            <button class="btn btn-check" onclick="m1_checkOrder()">é©—æ”¶æˆæœ</button>
            <button class="btn btn-hint" onclick="m1_showHint()">éœ€è¦æç¤ºå—ï¼ŸğŸ’¡</button>
            <div id="m1-feedback" class="feedback"></div>
            <button class="btn btn-next" onclick="showMission('mission-2')" style="display:none;" id="btn-m1-next">å‰å¾€ Mission 2 â¡ï¸</button>
        </section>

        <section id="mission-2" class="mission">
            <h2>Mission 2: æƒ…å ±æ’åº <span>(é¸æ“‡æ’åºæ³•)</span></h2>
            <p class="mission-intro">
                <strong>æ•™å®˜ï¼š</strong> ã€Œæƒ…å ±å“¡æˆªç²äº†ä¸€æ‰¹æ··äº‚çš„å¯†ç¢¼ï¼å¦‚æœä¸æ’åºï¼Œæˆ‘å€‘æ ¹æœ¬ç„¡æ³•ä½¿ç”¨ã€‚ä½ çš„ä»»å‹™æ˜¯å­¸ç¿’ã€é¸æ“‡æ’åºæ³•ã€ï¼ŒæŠŠæƒ…å ±æ•´ç†ä¹¾æ·¨ã€‚ã€
            </p>

            <h3>ä»»å‹™ 2-1: æ’åºæ³•æ¼”ç¤º</h3>
            <p id="m2-task-desc"><strong>ğŸ“– ä»»å‹™èªªæ˜ï¼š</strong> è§€å¯Ÿã€Œé¸æ“‡æ’åºæ³•ã€å¦‚ä½•è™•ç†é€™çµ„å¯†ç¢¼ï¼š[ 8, 5, 10, 1, 7 ]ã€‚å®ƒæœƒä¸€è¼ªä¸€è¼ªåœ°æ‰¾å‡ºã€Œæœªæ’åºã€ä¸­æœ€å°çš„æ•¸å­—ï¼Œæ”¾åˆ°ã€Œå·²æ’åºã€çš„æœ«ç«¯ã€‚</p>
            <div id="m2-viz-container" class="data-container">
                </div>
            <button class="btn" id="btn-m2-start" onclick="m2_startVisualization()">é–‹å§‹æ¼”ç¤º â–¶ï¸</button>
            <button class="btn btn-pause" id="btn-m2-pause" onclick="m2_togglePause()" disabled>æš«åœ â¸ï¸</button>
            <button class="btn btn-hint" id="btn-m2-new-example" onclick="m2_generate_new_example()">æ›ä¸€çµ„æ•¸å­— ğŸ²</button>


            <h3 style="margin-top: 30px;">ä»»å‹™ 2-2: ä¿®å¾© Scratch ç¨‹å¼</h3>
            <p><strong>ğŸ“– ä»»å‹™èªªæ˜ï¼š</strong> é€™æ˜¯ã€Œé¸æ“‡æ’åºæ³•ã€ä¸­ã€Œæ‰¾å‡ºæœ€å°å€¼ä½ç½®ã€çš„é—œéµç¨‹å¼ã€‚ä½†å®ƒå¥½åƒå£äº†ï¼è«‹æ‰¾å‡º <strong>(?)</strong> æ‡‰è©²å¡«å…¥ä»€éº¼ï¼Ÿ</p>
            
            <div class="scratch-puzzle-container">
                <div class="scratch-stack">
                    <div class="scratch-block scratch-block-data">
                        è¨­ [æœ€å°å€¼ä½ç½®] ç‚º <span class="scratch-inline-input">1</span>
                    </div>
                    <div class="scratch-block scratch-block-data">
                        è¨­ [è³‡æ–™ä½ç½®] ç‚º <span class="scratch-inline-input">2</span>
                    </div>
                    <div class="scratch-block scratch-block-control">
                        é‡è¤‡ <span class="scratch-inline-input">4</span> æ¬¡
                    </div>
                    <div class="scratch-stack"> <div class="scratch-block scratch-block-control">
                            å¦‚æœ
                            <div class="scratch-block scratch-block-operator" style="display:inline-flex; align-items: center; padding: 5px;">
                                <span class="scratch-inline-input">(åŸå§‹è³‡æ–™ çš„ ç¬¬ <div class="scratch-block scratch-block-data" style="margin: 0 3px;">è³‡æ–™ä½ç½®</div> é …)</span>
                                &lt;
                                <span class="scratch-inline-input">(åŸå§‹è³‡æ–™ çš„ ç¬¬ 
                                    <select id="m2-quiz-select" class="scratch-quiz-select">
                                        <option value="">(?)</option>
                                        <option value="è³‡æ–™ä½ç½®">è³‡æ–™ä½ç½®</option>
                                        <option value="æœ€å°å€¼ä½ç½®">æœ€å°å€¼ä½ç½®</option>
                                        <option value="1">1</option>
                                    </select>
                                é …)</span>
                            </div>
                            é‚£éº¼
                        </div>
                        <div class="scratch-stack"> <div class="scratch-block scratch-block-data">
                                è¨­ [æœ€å°å€¼ä½ç½®] ç‚º <div class="scratch-block scratch-block-data" style="display:inline-block; margin: 0 3px;">è³‡æ–™ä½ç½®</div>
                            </div>
                        </div>
                    </div>
                    <div class="scratch-block scratch-block-data" style="margin-top: 5px;">
                        æ”¹è®Š [è³‡æ–™ä½ç½®] <span class="scratch-inline-input">1</span>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-check" onclick="m2_checkQuiz()">æª¢æŸ¥ç­”æ¡ˆ</button>
            <button class="btn btn-hint" onclick="m2_showHint()">éœ€è¦æç¤ºå—ï¼ŸğŸ’¡</button>
            <div id="m2-feedback" class="feedback"></div>
            <button class="btn btn-next" onclick="showMission('mission-3')" style="display:none;" id="btn-m2-next">å‰å¾€ Mission 3 â¡ï¸</button>
        </section>

        <section id="mission-3" class="mission">
            <h2>Mission 3: é–å®šç›®æ¨™ <span>(å¾ªåº/äºŒå…ƒæœå°‹æ³•)</span></h2>
            <p class="mission-intro">
                <strong>æ•™å®˜ï¼š</strong> ã€Œæƒ…å ±æ’å¥½åºäº†ï¼Œç¾åœ¨æˆ‘å€‘è¦å¿«é€Ÿæ‰¾å‡ºç›®æ¨™ï¼ä¸åŒçš„æœå°‹æ–¹å¼ï¼Œæ•ˆç‡å¤©å·®åœ°é ã€‚é«”é©—çœ‹çœ‹å§ï¼ã€
            </p>

            <h3>ä»»å‹™ 3-1: å¾ªåºæœå°‹æ³•</h3>
            <p id="m3-seq-task-desc"><strong>ğŸ“– ä»»å‹™èªªæ˜ï¼š</strong> ...</p>
            <div id="m3-seq-container" class="data-container">
                </div>
            <p>ä½ å·²æ¯”è¼ƒäº† <strong id="m3-seq-count">0</strong> æ¬¡ã€‚</p>
            <button class="btn btn-reset" onclick="m3_resetSequential()">é‡è¨­æ­¤ä»»å‹™</button>
            <div id="m3-seq-feedback" class="feedback"></div>

            <h3 style="margin-top: 30px;">ä»»å‹™ 3-2: äºŒå…ƒæœå°‹æ³•</h3>
            <p id="m3-bin-task-desc"><strong>ğŸ“– ä»»å‹™èªªæ˜ï¼š</strong> ...</p>
            <div id="m3-bin-container" class="data-container">
                </div>
            <div id="m3-bin-guide">
                </div>
            <button class="btn btn-reset" onclick="m3_resetBinary()">é‡è¨­æ­¤ä»»å‹™</button>
            <div id="m3-bin-feedback" class="feedback"></div>
            
            <hr style="margin-top: 30px;">
            <div style="text-align: center;">
                <button class="btn btn-hint" id="btn-m3-new-example" onclick="m3_generate_new_example()">æ›å€‹æ–°ä»»å‹™ ğŸ²</button>
            </div>
            
            <button class="btn btn-next" onclick="showMission('mission-4')" style="display:none;" id="btn-m3-next">å‰å¾€æœ€çµ‚è©¦ç…‰ â¡ï¸</button>
        </section>

        <section id="mission-4" class="mission">
            <h2>Mission 4: æœ€çµ‚è©¦ç…‰ <span>(åˆ†çµ„åˆä½œ - æ¨¡æ“¬)</span></h2>
            <p class="mission-intro">
                <strong>æ•™å®˜ï¼š</strong> ã€Œé€™æ˜¯ä½ çš„ç•¢æ¥­è€ƒï¼åœ¨çœŸå¯¦æƒ…å¢ƒä¸­ï¼Œæ’åºå’Œæœå°‹æ˜¯é€£è²«çš„ã€‚ä½ å¿…é ˆå’Œä½ çš„ã€å¤¥ä¼´ã€åˆä½œè§£é–‹é‡‘åº«ã€‚ç”±æ–¼ä½ çš„å¤¥ä¼´ä»Šå¤©è«‹å‡... ä½ å¾—ä¸€äººåˆ†é£¾å…©è§’ï¼ã€
            </p>
            <p><strong>ğŸ“– ä»»å‹™èªªæ˜ï¼š</strong> 
                <br> <strong>Part 1 (æ’åº)ï¼š</strong> ç³»çµ±æœƒçµ¦ä½ ä¸€çµ„æ··äº‚çš„å¯†ç¢¼ã€‚è«‹ã€Œé»æ“Šã€æ•¸å­—ï¼Œå°‡å®ƒå€‘å¾å°åˆ°å¤§æ’åºã€‚
                <br> <strong>Part 2 (æœå°‹)ï¼š</strong> æ’åºå®Œæˆå¾Œï¼Œç³»çµ±æœƒçµ¦ä½ ä¸€å€‹ã€Œç›®æ¨™å¯†ç¢¼ã€ï¼Œè«‹ä½¿ç”¨ã€ŒäºŒå…ƒæœå°‹æ³•ã€æ‰¾å‡ºå®ƒã€‚
            </p>
            
            <h3>Part 1: æ’åºå¯†ç¢¼</h3>
            <div id="m4-sort-pool" class="data-container"></div>
            <p><strong>ä½ çš„æ’åºçµæœ (é»æ“Šä¸Šæ–¹æ•¸å­—ä¾†æ’åº)ï¼š</strong></p>
            <div id="m4-sort-result" class="data-container" style="min-height: 70px; background: #f9f9f9; border: 1px dashed #ccc;"></div>
            <button class="btn btn-check" onclick="m4_checkSort()">ç¢ºèªæ’åº</button>
            <button class="btn btn-hint" onclick="m4_showHint()">æ’åºæç¤ºğŸ’¡</button>
            <div id="m4-sort-feedback" class="feedback"></div>

            <div id="m4-part2" style="display:none;">
                <h3 style="margin-top: 30px;">Part 2: äºŒå…ƒæœå°‹</h3>
                <p><strong>ğŸ“– ä»»å‹™èªªæ˜ï¼š</strong> æ’åºå®Œæˆï¼ä½ çš„å¤¥ä¼´ï¼ˆç³»çµ±ï¼‰å‘Šè¨´ä½ ï¼Œç›®æ¨™å¯†ç¢¼æ˜¯ <strong id="m4-target-num"></strong>ã€‚è«‹ç”¨ã€ŒäºŒå…ƒæœå°‹æ³•ã€åœ¨ä½ çš„æ’åºçµæœä¸­æ‰¾å‡ºå®ƒï¼</p>
                <div id="m4-bin-container" class="data-container">
                    </div>
                <div id="m4-bin-guide">
                    </div>
                <div id="m4-bin-feedback" class="feedback"></div>
            </div>
            
            <div id="m4-final-feedback" class="feedback" style="text-align:center; font-size: 1.5rem; background: #dff0d8; color: #3c763d;">
                </div>
            
        </section>

    </main>

    <footer>
        <p>ã€Œæ¼”ç®—æ³•ç‰¹å‹™å­¸é™¢ã€ - æ•¸ä½å­¸ç¿’æ¨¡çµ„ Demo (v4)<br>
        éˆæ„Ÿä¾†æºï¼šç¿°æ—ç‰ˆå…«å¹´ç´šè³‡è¨Šç§‘æŠ€ (108èª²ç¶±) ç¬¬å…­ç« </p>
    </footer>

    <script>
        // --- å…¨å±€å·¥å…· ---
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // [v4 æ–°å¢] éš¨æ©Ÿé™£åˆ—ç”¢ç”Ÿå™¨
        function generateRandomArray(size = 5, min = 1, max = 20) {
            let arr = [];
            let s = new Set();
            while(s.size < size) {
                s.add(Math.floor(Math.random() * (max - min + 1)) + min);
            }
            return Array.from(s);
        }
        
        // --- å…¨å±€å°èˆª ---
        function showMission(missionId) {
            // éš±è—æ‰€æœ‰ä»»å‹™
            document.querySelectorAll('.mission').forEach(m => {
                m.style.display = 'none';
            });
            // é¡¯ç¤ºæŒ‡å®šä»»å‹™
            const targetMission = document.getElementById(missionId);
            if (targetMission) {
                targetMission.style.display = 'block';
            }
        }
        
        // é é¢è¼‰å…¥æ™‚ï¼Œé è¨­é¡¯ç¤ºä»»å‹™1
        document.addEventListener('DOMContentLoaded', () => {
            showMission('mission-1');
            m1_init();
            m2_init();
            m3_init();
            m4_init();
        });

        // --- ä»»å‹™ 1: æ‹–æ›³æ’åº (è›‹ç‚’é£¯) ---
        let m1_draggedItem = null;
        const m1_correctOrder = ["step-1", "step-2", "step-3", "step-4", "step-5", "step-6", "step-7"];

        function m1_init() {
            const pool = document.getElementById('item-pool');
            const zone = document.getElementById('drop-zone');
            zone.innerHTML = '';
            m1_correctOrder.forEach(id => {
                const item = document.getElementById(id);
                if (item) pool.appendChild(item);
            });
            document.querySelectorAll('.drag-item').forEach(item => item.classList.remove('hint-glow'));
            document.getElementById('m1-feedback').style.display = 'none';
            document.getElementById('btn-m1-next').style.display = 'none';
        }

        function m1_handleDragStart(e) { m1_draggedItem = e.target; }

        function m1_handleDrop(e) {
            e.preventDefault();
            const dropZone = e.target.closest('#drop-zone');
            if (dropZone && m1_draggedItem) {
                dropZone.appendChild(m1_draggedItem);
                m1_draggedItem = null;
            }
        }

        function m1_checkOrder() {
            const dropZone = document.getElementById('drop-zone');
            const items = dropZone.querySelectorAll('.drag-item');
            const feedback = document.getElementById('m1-feedback');
            
            let userOrder = Array.from(items).map(item => item.id);
            
            if (JSON.stringify(userOrder) === JSON.stringify(m1_correctOrder)) {
                feedback.textContent = 'ğŸ‰ å®Œç¾ï¼çœ‹ä¾†ä½ å¾ˆæœ‰ç•¶ç‰¹å‹™çš„å¤©è³¦ï¼è›‹ç‚’é£¯... å•Šä¸æ˜¯ï¼Œèƒ½é‡é£²å®Œæˆäº†ï¼';
                feedback.className = 'feedback success';
                document.getElementById('btn-m1-next').style.display = 'inline-block';
            } else {
                feedback.textContent = 'âŒ æ­¥é©ŸéŒ¯èª¤ï¼é€™å€‹å‘³é“...ä¸å¤ªå°å‹ã€‚å†è©¦ä¸€æ¬¡ï¼(æˆ–è€…æŒ‰æç¤ºæŒ‰éˆ•)';
                feedback.className = 'feedback error';
            }
            feedback.style.display = 'block';
        }

        function m1_showHint() {
            const dropZone = document.getElementById('drop-zone');
            const itemsInZone = dropZone.querySelectorAll('.drag-item');
            const nextStepIndex = itemsInZone.length;
            const feedback = document.getElementById('m1-feedback');
            
            document.querySelectorAll('.drag-item').forEach(item => item.classList.remove('hint-glow'));

            if (nextStepIndex >= m1_correctOrder.length) {
                feedback.textContent = 'ğŸ’¡ ä½ å·²ç¶“æŠŠæ‰€æœ‰æ­¥é©Ÿéƒ½æ”¾é€²å»äº†ï¼Œæª¢æŸ¥ä¸€ä¸‹é †åºå§ï¼';
                feedback.className = 'feedback hint';
                feedback.style.display = 'block';
                return;
            }
            
            const nextStepId = m1_correctOrder[nextStepIndex];
            const nextStepElement = document.getElementById(nextStepId);
            
            let hintText = '';
            switch(nextStepId) {
                case 'step-1': hintText = 'æç¤ºï¼šç¬¬ä¸€æ­¥ç•¶ç„¶æ˜¯... å…ˆå€’æ²¹ï¼'; break;
                case 'step-2': hintText = 'æç¤ºï¼šæ²¹å€’äº†ï¼Œæ¥ä¸‹ä¾†è¦... åŠ ç†±ï¼'; break;
                case 'step-3': hintText = 'æç¤ºï¼šæ²¹ç†±äº†ï¼Œè©²æ”¾ä»€éº¼ä¸‹å»äº†ï¼Ÿ (è›‹)'; break;
                case 'step-4': hintText = 'æç¤ºï¼šè›‹ä¸‹é‹äº†ï¼Œè¦å¿«é»... æ”ªæ‹Œï¼'; break;
                case 'step-5': hintText = 'æç¤ºï¼šè›‹ç†Ÿäº†ï¼Œä¸»è§’... ç±³é£¯ç™»å ´ï¼'; break;
                case 'step-6': hintText = 'æç¤ºï¼šé£¯æ”¾é€²å»äº†ï¼Œè¦æŠŠå®ƒ... ç‚’æ•£ï¼'; break;
                case 'step-7': hintText = 'æç¤ºï¼šæœ€å¾Œä¸€æ­¥ï¼Œè®“å®ƒè®Šå¥½åƒ... èª¿å‘³ï¼'; break;
            }

            feedback.textContent = hintText;
            feedback.className = 'feedback hint';
            feedback.style.display = 'block';

            if (nextStepElement && nextStepElement.parentElement.id === 'item-pool') {
                nextStepElement.classList.add('hint-glow');
            }
        }

        // --- ä»»å‹™ 2: é¸æ“‡æ’åºæ³• (v4 æš«åœä¿®å¾© / æ›´å¤šç¯„ä¾‹) ---
        let m2_data = [8, 5, 10, 1, 7];
        let m2_viz_container = document.getElementById('m2-viz-container');
        let m2_isPaused = false;
        let m2_pausePromiseResolver = null;
        let m2_isRunning = false;

        // [v4 ä¿®å¾©] å¯æš«åœçš„ sleep å‡½å¼
        async function m2_pausableSleep(ms) {
            await sleep(ms); // æ­£å¸¸çš„å»¶é²
            if (m2_isPaused) {
                // å¦‚æœæ˜¯æš«åœç‹€æ…‹ï¼Œå»ºç«‹ä¸€å€‹ Promise ä¸¦ç­‰å¾…å®ƒè¢« resolve
                await new Promise(resolve => {
                    m2_pausePromiseResolver = resolve;
                });
            }
        }

        // [v4 ä¿®å¾©] æš«åœ/ç¹¼çºŒ åˆ‡æ›
        function m2_togglePause() {
            if (!m2_isRunning) return; // æ²’åœ¨è·‘ï¼ŒæŒ‰äº†ä¹Ÿæ²’ç”¨
            
            m2_isPaused = !m2_isPaused;
            const pauseBtn = document.getElementById('btn-m2-pause');
            
            if (m2_isPaused) {
                pauseBtn.textContent = 'ç¹¼çºŒ â–¶ï¸';
            } else {
                pauseBtn.textContent = 'æš«åœ â¸ï¸';
                if (m2_pausePromiseResolver) {
                    // å¦‚æœ m2_pausableSleep æ­£åœ¨ç­‰å¾…ï¼Œå°±å‘¼å«å®ƒçš„ resolve() è®“å®ƒç¹¼çºŒ
                    m2_pausePromiseResolver();
                    m2_pausePromiseResolver = null;
                }
            }
        }

        function m2_init() {
            m2_generate_new_example(true); // åˆå§‹è¼‰å…¥é è¨­ç¯„ä¾‹
            document.getElementById('m2-feedback').style.display = 'none';
            document.getElementById('btn-m2-next').style.display = 'none';
            document.getElementById('m2-quiz-select').value = '';
        }

        // [v4 æ–°å¢] ç”¢ç”Ÿæ–°ç¯„ä¾‹
        function m2_generate_new_example(isDefault = false) {
            if (m2_isRunning) return; // å‹•ç•«ä¸­ï¼Œä¸çµ¦æ›
            
            if (isDefault) {
                m2_data = [8, 5, 10, 1, 7];
            } else {
                m2_data = generateRandomArray(5, 1, 20);
            }
            
            document.getElementById('m2-task-desc').innerHTML = `<strong>ğŸ“– ä»»å‹™èªªæ˜ï¼š</strong> è§€å¯Ÿã€Œé¸æ“‡æ’åºæ³•ã€å¦‚ä½•è™•ç†é€™çµ„å¯†ç¢¼ï¼š[ ${m2_data.join(', ')} ]ã€‚å®ƒæœƒä¸€è¼ªä¸€è¼ªåœ°æ‰¾å‡ºã€Œæœªæ’åºã€ä¸­æœ€å°çš„æ•¸å­—ï¼Œæ”¾åˆ°ã€Œå·²æ’åºã€çš„æœ«ç«¯ã€‚`;
            m2_resetVisualization();
        }
        
        // m2_resetVisualization åªè² è²¬ç¹ªè£½ç•¶å‰çš„ m2_data
        function m2_resetVisualization() {
            m2_viz_container.innerHTML = '';
            m2_data.forEach(val => {
                let box = document.createElement('div');
                box.className = 'data-box';
                box.textContent = val;
                m2_viz_container.appendChild(box);
            });
            // é‡ç½®ç‹€æ…‹
            m2_isRunning = false;
            m2_isPaused = false;
            if (m2_pausePromiseResolver) {
                m2_pausePromiseResolver();
                m2_pausePromiseResolver = null;
            }
            document.getElementById('btn-m2-pause').textContent = 'æš«åœ â¸ï¸';
            document.getElementById('btn-m2-pause').disabled = true;
            document.getElementById('btn-m2-start').disabled = false;
            document.getElementById('btn-m2-new-example').disabled = false;
        }
        
        async function m2_startVisualization() {
            if (m2_isRunning) return; // é˜²æ­¢é‡è¤‡åŸ·è¡Œ
            m2_isRunning = true;
            document.getElementById('btn-m2-pause').disabled = false;
            document.getElementById('btn-m2-start').disabled = true;
            document.getElementById('btn-m2-new-example').disabled = true;
            
            // é‡æ–°ç¹ªè£½ï¼Œç¢ºä¿æ˜¯ä¹¾æ·¨çš„ç‹€æ…‹
            m2_viz_container.innerHTML = '';
            m2_data.forEach(val => {
                let box = document.createElement('div');
                box.className = 'data-box';
                box.textContent = val;
                m2_viz_container.appendChild(box);
            });
            let boxes = m2_viz_container.querySelectorAll('.data-box');
            let n = boxes.length;

            try {
                for (let i = 0; i < n - 1; i++) {
                    let minIdx = i;
                    boxes[i].classList.add('highlight-swap'); // æ¨™è¨˜ç•¶å‰æ¯”è¼ƒçš„åŸºæº–
                    await m2_pausableSleep(800);

                    // æ‰¾åˆ°æœªæ’åºéƒ¨åˆ†ä¸­çš„æœ€å°å€¼
                    for (let j = i + 1; j < n; j++) {
                        boxes[j].classList.add('highlight-min'); // æ¨™è¨˜æ­£åœ¨æª¢æŸ¥çš„
                        await m2_pausableSleep(500);
                        if (parseInt(boxes[j].textContent) < parseInt(boxes[minIdx].textContent)) {
                            boxes[minIdx].classList.remove('highlight-min', 'highlight-swap');
                            minIdx = j;
                            boxes[minIdx].classList.add('highlight-min'); // æ¨™è¨˜æ–°çš„æœ€å°å€¼
                        } else {
                            boxes[j].classList.remove('highlight-min');
                        }
                    }
                    
                    await m2_pausableSleep(800);

                    // äº¤æ›
                    let temp = boxes[i].textContent;
                    boxes[i].textContent = boxes[minIdx].textContent;
                    boxes[minIdx].textContent = temp;

                    // æ¸…é™¤æ¨£å¼
                    boxes.forEach(box => box.classList.remove('highlight-min', 'highlight-swap'));
                    boxes[i].classList.add('sorted'); // æ¨™è¨˜å·²æ’åº
                }
                boxes[n - 1].classList.add('sorted');
            } catch (e) {
                console.error("Animation stopped:", e);
            } finally {
                // æ¼”ç¤ºçµæŸ
                m2_isRunning = false;
                m2_isPaused = false;
                document.getElementById('btn-m2-pause').textContent = 'æš«åœ â¸ï¸';
                document.getElementById('btn-m2-pause').disabled = true;
                document.getElementById('btn-m2-start').disabled = false;
                document.getElementById('btn-m2-new-example').disabled = false;
            }
        }

        function m2_checkQuiz() {
            const answer = document.getElementById('m2-quiz-select').value;
            const feedback = document.getElementById('m2-feedback');
            if (answer === 'æœ€å°å€¼ä½ç½®') {
                feedback.textContent = 'ğŸ‰ æ­£ç¢ºï¼å°±æ˜¯è¦è·Ÿç•¶å‰ç´€éŒ„çš„ã€Œæœ€å°å€¼ä½ç½®ã€ä¸Šçš„æ•¸å­—æ¯”è¼ƒã€‚ç¨‹å¼ä¿®å¾©å®Œç•¢ï¼';
                feedback.className = 'feedback success';
                document.getElementById('btn-m2-next').style.display = 'inline-block';
            } else {
                feedback.textContent = 'âŒ éŒ¯èª¤ï¼å†æƒ³æƒ³çœ‹ï¼Œæˆ–æŒ‰æç¤ºéˆ•ã€‚';
                feedback.className = 'feedback error';
            }
            feedback.style.display = 'block';
        }

        function m2_showHint() {
            const feedback = document.getElementById('m2-feedback');
            feedback.textContent = 'ğŸ’¡ æç¤ºï¼šæˆ‘å€‘è¦æ¯”è¼ƒçš„æ˜¯ã€Œç›®å‰æ­£åœ¨æª¢æŸ¥çš„é …ç›®ã€(ç”± [è³‡æ–™ä½ç½®] æ§åˆ¶) å’Œã€Œæˆ‘å€‘*æš«æ™‚*æ‰¾åˆ°çš„æœ€å°é …ç›®ã€(ç”± [æœ€å°å€¼ä½ç½®] æ§åˆ¶)ã€‚æ‰€ä»¥ (?) æ‡‰è©²æ˜¯...ï¼Ÿ';
            feedback.className = 'feedback hint';
            feedback.style.display = 'block';
        }

        // --- ä»»å‹™ 3: æœå°‹ (v4 æ›´å¤šç¯„ä¾‹) ---
        let m3_seq_data = [];
        let m3_seq_target = 0;
        let m3_seq_count = 0;
        let m3_seq_found = false;

        let m3_bin_data = [];
        let m3_bin_target = 0;
        
        function m3_init() {
            m3_generate_new_example(true); // è¼‰å…¥ç¬¬ä¸€å€‹ç¯„ä¾‹
            document.getElementById('btn-m3-next').style.display = 'none';
        }

        // [v4 æ–°å¢] ç”¢ç”Ÿæ–°ç¯„ä¾‹
        function m3_generate_new_example(isDefault = false) {
            if (isDefault) {
                // å¾ªåº
                m3_seq_data = [8, 5, 10, 1, 7];
                m3_seq_target = 10;
                // äºŒå…ƒ
                m3_bin_data = [1, 5, 7, 8, 10];
                m3_bin_target = 10;
            } else {
                // å¾ªåº
                m3_seq_data = generateRandomArray(5, 1, 20);
                m3_seq_target = m3_seq_data[Math.floor(Math.random() * m3_seq_data.length)]; // ç¢ºä¿ç›®æ¨™å­˜åœ¨
                // äºŒå…ƒ
                let temp_bin = generateRandomArray(5, 1, 20);
                m3_bin_data = [...temp_bin].sort((a,b) => a-b);
                m3_bin_target = m3_bin_data[Math.floor(Math.random() * m3_bin_data.length)]; // ç¢ºä¿ç›®æ¨™å­˜åœ¨
            }

            // æ›´æ–°ä»»å‹™èªªæ˜
            document.getElementById('m3-seq-task-desc').innerHTML = `<strong>ğŸ“– ä»»å‹™èªªæ˜ï¼š</strong> åœ¨é€™å † <strong>æœªæ’åº</strong> çš„å½ˆè—¥ç®± [ ${m3_seq_data.join(', ')} ] ä¸­ï¼Œæ‰¾å‡º <strong>${m3_seq_target}è™Ÿ</strong> å½ˆè—¥ã€‚ä½ å¿…é ˆ *å¾å·¦åˆ°å³* ä¾åºé»æ“Šæª¢æŸ¥ï¼`;
            document.getElementById('m3-bin-task-desc').innerHTML = `<strong>ğŸ“– ä»»å‹™èªªæ˜ï¼š</strong> é€™æ¬¡å½ˆè—¥ç®± <strong>å·²æ’åº</strong> [ ${m3_bin_data.join(', ')} ]ã€‚æˆ‘å€‘è¦æ‰¾å‡º <strong>${m3_bin_target}è™Ÿ</strong> å½ˆè—¥ã€‚è«‹è·Ÿéš¨ç³»çµ±çš„æç¤ºï¼`;

            // é‡è¨­å…©å€‹ä»»å‹™
            m3_resetSequential();
            m3_resetBinary();
            document.getElementById('btn-m3-next').style.display = 'none';
        }

        // 3-1 å¾ªåºæœå°‹
        function m3_resetSequential() {
            const container = document.getElementById('m3-seq-container');
            container.innerHTML = '';
            m3_seq_count = 0;
            m3_seq_found = false;
            document.getElementById('m3-seq-count').textContent = '0';
            document.getElementById('m3-seq-feedback').style.display = 'none';
            
            m3_seq_data.forEach((val, index) => {
                let box = document.createElement('div');
                box.className = 'data-box search-target';
                box.textContent = val;
                box.onclick = () => m3_checkSequential(box, val, index);
                container.appendChild(box);
            });
        }
        
        function m3_checkSequential(box, val, index) {
            if (m3_seq_found) return; 
            
            const feedback = document.getElementById('m3-seq-feedback');
            if (index !== m3_seq_count) {
                feedback.textContent = `âŒ é»éŒ¯é †åºäº†ï¼ã€Œå¾ªåºã€æœå°‹çš„SOPï¼Œå°±æ˜¯å¾*æœ€å·¦é‚Š*ä¸€å€‹ä¸€å€‹ä¾†ã€‚è«‹é»æ“Šç¬¬ ${m3_seq_count + 1} å€‹æ–¹å¡Šã€‚`;
                feedback.className = 'feedback error';
                feedback.style.display = 'block';
                return;
            }

            m3_seq_count++;
            document.getElementById('m3-seq-count').textContent = m3_seq_count;
            box.classList.add('highlight-swap'); 

            if (val === m3_seq_target) {
                m3_seq_found = true;
                feedback.textContent = `ğŸ‰ æ‰¾åˆ°äº†ï¼ç›®æ¨™æ˜¯ ${val}ã€‚ä½ ç¸½å…±æ¯”è¼ƒäº† ${m3_seq_count} æ¬¡ã€‚`;
                feedback.className = 'feedback success';
                box.classList.add('sorted');
                // æª¢æŸ¥æ˜¯å¦å…©å€‹ä»»å‹™éƒ½å®Œæˆäº†
                if (document.getElementById('m3-bin-feedback').classList.contains('success')) {
                    document.getElementById('btn-m3-next').style.display = 'inline-block';
                }
            } else {
                feedback.textContent = `ç¬¬ ${m3_seq_count} æ¬¡ï¼š ${val} ä¸æ˜¯ç›®æ¨™... ç¹¼çºŒæ‰¾ä¸‹ä¸€å€‹ã€‚`;
                feedback.className = 'feedback hint'; 
            }
            feedback.style.display = 'block';
        }

        // 3-2 äºŒå…ƒæœå°‹
        function m3_resetBinary() {
            const container = document.getElementById('m3-bin-container');
            container.innerHTML = '';
            m3_bin_data.forEach(val => {
                let box = document.createElement('div');
                box.className = 'data-box';
                box.textContent = val;
                container.appendChild(box);
            });
            document.getElementById('m3-bin-feedback').style.display = 'none';
            document.getElementById('m3-bin-feedback').classList.remove('success');
            m3_startBinarySearch(0, m3_bin_data.length - 1, 0); 
        }

        function m3_startBinarySearch(low, high, count) { 
            const guide = document.getElementById('m3-bin-guide');
            const feedback = document.getElementById('m3-bin-feedback');
            const boxes = document.querySelectorAll('#m3-bin-container .data-box');
            
            boxes.forEach((box, i) => {
                if (i >= low && i <= high) {
                    box.classList.remove('disabled');
                } else {
                    box.classList.add('disabled');
                }
            });

            if (low > high) {
                feedback.textContent = 'âŒ å’¦ï¼Ÿç¯„åœå…§æ‰¾ä¸åˆ°äº†ï¼ä»»å‹™å¤±æ•—ã€‚';
                feedback.className = 'feedback error';
                feedback.style.display = 'block';
                return;
            }

            let mid = Math.floor((low + high) / 2);
            let midVal = m3_bin_data[mid];
            let newCount = count + 1; 
            
            boxes[mid].classList.add('highlight-min'); 

            guide.innerHTML = `
                <p><strong>ç¬¬ ${newCount} æ¬¡æ¯”è¼ƒï¼š</strong></p>
                <p>ç›®å‰æœå°‹ç¯„åœï¼šç´¢å¼• [${low}] åˆ° [${high}]ã€‚</p>
                <p>æˆ‘å€‘æª¢æŸ¥ä¸­é–“ä½ç½® (ç´¢å¼• ${mid})ï¼Œæ•¸å­—æ˜¯ <strong>${midVal}</strong>ã€‚</p>
                <p>ç›®æ¨™ <strong>${m3_bin_target}</strong> æ¯” <strong>${midVal}</strong> ...ï¼Ÿ</p>
                <button class="btn" onclick="m3_handleBinaryChoice(${low}, ${high}, ${mid}, 'less', ${newCount})">å°</button>
                <button class="btn" onclick="m3_handleBinaryChoice(${low}, ${high}, ${mid}, 'equal', ${newCount})">ç­‰æ–¼</button>
                <button class="btn" onclick="m3_handleBinaryChoice(${low}, ${high}, ${mid}, 'more', ${newCount})">å¤§</button>
            `;
        }

        function m3_handleBinaryChoice(low, high, mid, choice, count) { 
            const midVal = m3_bin_data[mid];
            const feedback = document.getElementById('m3-bin-feedback');
            const boxes = document.querySelectorAll('#m3-bin-container .data-box');
            boxes[mid].classList.remove('highlight-min');

            let correctChoice = '';
            if (m3_bin_target < midVal) correctChoice = 'less';
            else if (m3_bin_target > midVal) correctChoice = 'more';
            else correctChoice = 'equal';

            if (choice !== correctChoice) {
                feedback.textContent = `âŒ åˆ¤æ–·éŒ¯èª¤ï¼å†æƒ³ä¸€ä¸‹... æˆ‘å€‘çš„ç›®æ¨™æ˜¯ ${m3_bin_target}ï¼Œè€Œä¸­é–“å€¼æ˜¯ ${midVal}ã€‚ ${m3_bin_target} æ‡‰è©²åœ¨ ${midVal} çš„å“ªä¸€é‚Šå‘¢ï¼Ÿ`;
                feedback.className = 'feedback error';
                feedback.style.display = 'block';
                m3_startBinarySearch(low, high, count - 1); 
                return;
            }

            feedback.style.display = 'none'; 

            if (choice === 'equal') {
                feedback.textContent = `ğŸ‰ æ‰¾åˆ°äº†ï¼ç›®æ¨™å°±æ˜¯ ${midVal}ï¼ç¸½å…±æ¯”è¼ƒäº† ${count} æ¬¡ã€‚`;
                feedback.className = 'feedback success'; // æ¨™è¨˜æˆåŠŸ
                feedback.style.display = 'block';
                boxes[mid].classList.add('sorted');
                document.getElementById('m3-bin-guide').innerHTML = '';
                // æª¢æŸ¥æ˜¯å¦å…©å€‹ä»»å‹™éƒ½å®Œæˆäº†
                if (m3_seq_found) {
                    document.getElementById('btn-m3-next').style.display = 'inline-block';
                }
            } else if (choice === 'less') {
                m3_startBinarySearch(low, mid - 1, count); 
            } else if (choice === 'more') {
                m3_startBinarySearch(mid + 1, high, count);
            }
        }

        // --- ä»»å‹™ 4: æœ€çµ‚è©¦ç…‰ ---
        let m4_data = [];
        let m4_sorted_data = [];
        let m4_target = 0; 
        
        function m4_init() {
            const pool = document.getElementById('m4-sort-pool');
            const result = document.getElementById('m4-sort-result');
            pool.innerHTML = '';
            result.innerHTML = '';
            m4_sorted_data = [];
            
            m4_data = generateRandomArray(5, 1, 100);
            m4_target = m4_data[Math.floor(Math.random() * m4_data.length)]; 
            
            m4_data.forEach(val => {
                let box = document.createElement('div');
                box.className = 'data-box search-target';
                box.textContent = val;
                box.onclick = () => m4_addToSort(box, val);
                pool.appendChild(box);
            });
            
            document.getElementById('m4-target-num').textContent = m4_target;
            document.getElementById('m4-part2').style.display = 'none';
            document.getElementById('m4-sort-feedback').style.display = 'none';
            document.getElementById('m4-bin-feedback').style.display = 'none';
            document.getElementById('m4-final-feedback').style.display = 'none';
        }

        function m4_addToSort(box, val) {
            m4_sorted_data.push(val);
            const result = document.getElementById('m4-sort-result');
            let newBox = document.createElement('div');
            newBox.className = 'data-box';
            newBox.textContent = val;
            result.appendChild(newBox);
            box.style.display = 'none'; 
        }

        function m4_checkSort() {
            const feedback = document.getElementById('m4-sort-feedback');
            let correctSorted = [...m4_data].sort((a, b) => a - b);
            
            if (JSON.stringify(m4_sorted_data) === JSON.stringify(correctSorted)) {
                feedback.textContent = 'ğŸ‰ æ’åºæ­£ç¢ºï¼æº–å‚™é€²è¡Œ Part 2ï¼';
                feedback.className = 'feedback success';
                document.getElementById('m4-part2').style.display = 'block';
                m4_startBinarySearch(0, m4_sorted_data.length - 1, 0); 
            } else {
                feedback.textContent = 'âŒ æ’åºéŒ¯èª¤ï¼è«‹é‡è¨­ä¸¦å†è©¦ä¸€æ¬¡ã€‚(æˆ–æŒ‰æç¤º)';
                feedback.className = 'feedback error';
                setTimeout(() => { 
                    m4_init();
                }, 1500);
            }
            feedback.style.display = 'block';
        }

        function m4_showHint() {
            const feedback = document.getElementById('m4-sort-feedback');
            let correctSorted = [...m4_data].sort((a, b) => a - b);
            if(m4_sorted_data.length >= correctSorted.length) {
                feedback.textContent = 'ğŸ’¡ ä½ å·²ç¶“é¸å®Œæ‰€æœ‰æ•¸å­—äº†ï¼ŒæŒ‰ã€Œç¢ºèªæ’åºã€å§ï¼';
                feedback.className = 'feedback hint';
                feedback.style.display = 'block';
                return;
            }
            let nextNum = correctSorted[m4_sorted_data.length];
            feedback.textContent = 'ğŸ’¡ æç¤ºï¼šã€å¾å°æ’åˆ°å¤§ã€ï¼Œä½ é¸çš„ä¸‹ä¸€å€‹æ•¸å­—ï¼Œæ‡‰è©²æ˜¯å‰©ä¸‹æ•¸å­—ä¸­æœ€å°çš„... ä¹Ÿå°±æ˜¯ ' + nextNum + 'ã€‚';
            feedback.className = 'feedback hint';
            feedback.style.display = 'block';
        }
        
        function m4_startBinarySearch(low, high, count) { 
            const guide = document.getElementById('m4-bin-guide');
            const feedback = document.getElementById('m4-bin-feedback');
            const container = document.getElementById('m4-bin-container');
            
            container.innerHTML = '';
            m4_sorted_data.forEach(val => {
                let box = document.createElement('div');
                box.className = 'data-box';
                box.textContent = val;
                container.appendChild(box);
            });
            const boxes = container.querySelectorAll('.data-box');

            boxes.forEach((box, i) => {
                if (i >= low && i <= high) box.classList.remove('disabled');
                else box.classList.add('disabled');
            });

            if (low > high) {
                feedback.textContent = 'âŒ å’¦ï¼Ÿä½ æ˜¯ä¸æ˜¯æéŒ¯äº†ï¼Ÿæ‰¾ä¸åˆ°äº†...';
                feedback.className = 'feedback error';
                feedback.style.display = 'block';
                return;
            }

            let mid = Math.floor((low + high) / 2);
            let midVal = m4_sorted_data[mid];
            let newCount = count + 1; 
            
            boxes[mid].classList.add('highlight-min');

            guide.innerHTML = `
                <p><strong>ç¬¬ ${newCount} æ¬¡æ¯”è¼ƒï¼š</strong></p>
                <p>æœå°‹ç¯„åœ [${low}] åˆ° [${high}]ã€‚ä¸­é–“ (ç´¢å¼• ${mid}) æ˜¯ <strong>${midVal}</strong>ã€‚</p>
                <p>ç›®æ¨™ <strong>${m4_target}</strong> å’Œ <strong>${midVal}</strong> ç›¸æ¯”ï¼Ÿ</p>
                <button class="btn" onclick="m4_handleBinaryChoice(${low}, ${high}, ${mid}, 'less', ${newCount})">å°</button>
                <button class="btn" onclick="m4_handleBinaryChoice(${low}, ${high}, ${mid}, 'equal', ${newCount})">ç­‰æ–¼</button>
                <button class="btn" onclick="m4_handleBinaryChoice(${low}, ${high}, ${mid}, 'more', ${newCount})">å¤§</button>
            `;
        }

        function m4_handleBinaryChoice(low, high, mid, choice, count) { 
            const midVal = m4_sorted_data[mid];
            const feedback = document.getElementById('m4-bin-feedback');
            
            let correctChoice = '';
            if (m4_target < midVal) correctChoice = 'less';
            else if (m4_target > midVal) correctChoice = 'more';
            else correctChoice = 'equal';

            if (choice !== correctChoice) {
                feedback.textContent = `âŒ åˆ¤æ–·éŒ¯èª¤ï¼å†æƒ³ä¸€ä¸‹... æˆ‘å€‘çš„ç›®æ¨™æ˜¯ ${m4_target}ï¼Œè€Œä¸­é–“å€¼æ˜¯ ${midVal}ã€‚ ${m4_target} æ‡‰è©²åœ¨ ${midVal} çš„å“ªä¸€é‚Šå‘¢ï¼Ÿ`;
                feedback.className = 'feedback error';
                feedback.style.display = 'block';
                m4_startBinarySearch(low, high, count - 1); 
                return;
            }
            
            feedback.style.display = 'none';

            if (choice === 'equal') {
                document.getElementById('m4-final-feedback').innerHTML = `
                ğŸ† ä»»å‹™å®Œæˆï¼ ğŸ†
                <p>æ­å–œä½ ï¼Œæ¢å“¡ï¼ä½ å·²ç¶“æŒæ¡äº†æ¼”ç®—æ³•çš„æ ¸å¿ƒï¼ä½ å·²é †åˆ©ç•¢æ¥­ï¼</p>
                <button class="btn btn-next" onclick="location.reload()">é‡æ–°æŒ‘æˆ°å­¸é™¢</button>
                `;
                document.getElementById('m4-final-feedback').style.display = 'block';
                document.querySelector(`#m4-bin-container .data-box:nth-child(${mid + 1})`).classList.add('sorted');
                document.getElementById('m4-bin-guide').innerHTML = '';
            } else if (choice === 'less') {
                m4_startBinarySearch(low, mid - 1, count);
            } else if (choice === 'more') {
                m4_startBinarySearch(mid + 1, high, count);
            }
        }

    </script>
</body>
</html>