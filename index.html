<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>演算法特務學院 (v4 - 暫停修復/更多範例)</title>
    <style>
        /* --- 全局樣式 --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f0f4f8;
            color: #333;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* --- 標題欄 --- */
        header {
            background: linear-gradient(135deg, #4a90e2, #50e3c2);
            color: white;
            padding: 20px 40px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-bottom: 5px solid #43a047;
        }
        header h1 { margin: 0; font-size: 2.5rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        header p { margin: 5px 0 0; font-size: 1.2rem; opacity: 0.9; }

        /* --- 主內容區 --- */
        main { max-width: 900px; margin: 30px auto; padding: 20px; }

        /* --- 任務卡片樣式 --- */
        .mission {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            padding: 25px 30px;
            border: 1px solid #e0e0e0;
            display: none; /* 預設隱藏所有任務 */
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .mission h2 {
            color: #4a90e2;
            border-bottom: 2px solid #f0f4f8;
            padding-bottom: 10px;
            font-size: 2rem;
            margin-top: 0;
        }
        .mission h2 span {
            font-size: 1rem;
            color: #777;
            font-weight: normal;
            margin-left: 10px;
            background: #eee;
            padding: 3px 8px;
            border-radius: 5px;
        }
        .mission-intro {
            font-size: 1.1rem;
            background: #f9f9f9;
            border-left: 5px solid #50e3c2;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        /* --- 互動按鈕 --- */
        .btn {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin: 5px; /* 增加間距 */
        }
        .btn:hover:not(:disabled) {
            background-color: #357ABD;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .btn-next { background-color: #4CAF50; }
        .btn-next:hover:not(:disabled) { background-color: #43a047; }
        .btn-check { background-color: #f39c12; }
        .btn-check:hover:not(:disabled) { background-color: #e67e22; }
        .btn-reset { background-color: #e74c3c; }
        .btn-reset:hover:not(:disabled) { background-color: #c0392b; }
        .btn-hint { background-color: #9b59b6; }
        .btn-hint:hover:not(:disabled) { background-color: #8e44ad; }
        .btn-pause { background-color: #3498db; }
        .btn-pause:hover:not(:disabled) { background-color: #2980b9; }

        /* --- 任務1：拖曳排序 --- */
        #drop-zone {
            background: #fdfdfd;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            margin: 20px 0;
        }
        .drag-item {
            background-color: #50e3c2;
            color: #333;
            padding: 10px 15px;
            margin: 10px;
            border-radius: 5px;
            cursor: move;
            text-align: center;
            font-weight: bold;
            border: 1px solid #43a047;
        }
        #item-pool {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            background: #f0f4f8;
            padding: 10px;
            border-radius: 8px;
        }
        .drag-item.hint-glow { animation: glow 1.5s infinite; }
        @keyframes glow {
            0% { box-shadow: 0 0 5px #9b59b6; }
            50% { box-shadow: 0 0 20px #9b59b6; }
            100% { box-shadow: 0 0 5px #9b59b6; }
        }

        /* --- 任務2 & 3：視覺化方塊 --- */
        .data-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            flex-wrap: wrap;
        }
        .data-box {
            width: 60px;
            height: 60px;
            background: #e0e0e0;
            border: 1px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 8px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .data-box.highlight-min {
            background-color: #f39c12; /* 橘色 */
            color: white;
            border-color: #e67e22;
        }
        .data-box.highlight-swap {
            background-color: #e74c3c; /* 紅色 */
            color: white;
            border-color: #c0392b;
        }
        .data-box.sorted {
            background-color: #4CAF50; /* 綠色 */
            color: white;
            border-color: #43a047;
        }
        .data-box.search-target { cursor: pointer; }
        .data-box.search-target:hover { transform: scale(1.1); }
        .data-box.disabled {
            background: #f5f5f5;
            color: #bbb;
            opacity: 0.6;
        }

        /* --- [v4 確認] Scratch 積木樣式 --- */
        .scratch-puzzle-container {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .scratch-stack {
            padding-left: 20px; /* 模擬堆疊縮排 */
        }
        .scratch-block {
            padding: 8px 12px;
            color: white;
            border-radius: 5px;
            margin-bottom: 5px;
            font-weight: bold;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            display: inline-block; /* 讓積木寬度自適應 */
            min-width: 40px;
            text-align: center;
        }
        .scratch-block-control { background-color: #ffab19; } /* 控制 (橘色) */
        .scratch-block-data { background-color: #ff8c1a; } /* 變數 (深橘) */
        .scratch-block-operator { background-color: #59c059; } /* 運算 (綠色) */
        
        .scratch-inline-input {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 2px 8px;
            color: black;
            font-weight: normal;
            display: inline-block;
            min-width: 30px;
        }
        .scratch-quiz-select {
            font-size: 1rem;
            padding: 5px;
            border: 2px solid #4a90e2;
            border-radius: 5px;
            margin: 0 5px;
        }
        
        /* --- 結果提示 --- */
        .feedback {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
        .feedback.success {
            background: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .feedback.error {
            background: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .feedback.hint {
            background: #fcf8e3;
            color: #8a6d3b;
            border: 1px solid #faebcc;
        }

        /* --- 頁腳 --- */
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            background: #333;
            color: #aaa;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <header>
        <h1>🕵️ 演算法特務學院 🕵️</h1>
        <p>你的任務，就是學會如何聰明地解決問題！</p>
    </header>

    <main>

        <section id="mission-1" class="mission">
            <h2>Mission 1: 特務的食譜 <span>(演算法基礎)</span></h2>
            <p class="mission-intro">
                <strong>教官：</strong> 「探員，歡迎來到學院！演算法就是『解決問題的步驟』。你的第一個任務：按照『機密食譜』(蛋炒飯)的正確步驟，準備你的能量餐！」
            </p>
            <p><strong>📖 任務說明：</strong> 請將下方的步驟拖曳到上方的「烹飪區」中，並排列成正確的順序。</p>
            
            <div id="drop-zone" ondragover="event.preventDefault()" ondrop="m1_handleDrop(event)">
                </div>

            <div id="item-pool">
                <div class="drag-item" id="step-3" draggable="true" ondragstart="m1_handleDragStart(event)">開中火，加入蛋</div>
                <div class="drag-item" id="step-1" draggable="true" ondragstart="m1_handleDragStart(event)">放入適量的油至鍋中</div>
                <div class="drag-item" id="step-5" draggable="true" ondragstart="m1_handleDragStart(event)">加入米飯</div>
                <div class="drag-item" id="step-2" draggable="true" ondragstart="m1_handleDragStart(event)">加熱 (直到油熱了)</div>
                <div class="drag-item" id="step-7" draggable="true" ondragstart="m1_handleDragStart(event)">加入調味料拌勻</div>
                <div class="drag-item" id="step-4" draggable="true" ondragstart="m1_handleDragStart(event)">快速攪拌 (直到蛋凝固)</div>
                <div class="drag-item" id="step-6" draggable="true" ondragstart="m1_handleDragStart(event)">翻炒 (直到米飯散開)</div>
            </div>

            <button class="btn btn-check" onclick="m1_checkOrder()">驗收成果</button>
            <button class="btn btn-hint" onclick="m1_showHint()">需要提示嗎？💡</button>
            <div id="m1-feedback" class="feedback"></div>
            <button class="btn btn-next" onclick="showMission('mission-2')" style="display:none;" id="btn-m1-next">前往 Mission 2 ➡️</button>
        </section>

        <section id="mission-2" class="mission">
            <h2>Mission 2: 情報排序 <span>(選擇排序法)</span></h2>
            <p class="mission-intro">
                <strong>教官：</strong> 「情報員截獲了一批混亂的密碼！如果不排序，我們根本無法使用。你的任務是學習『選擇排序法』，把情報整理乾淨。」
            </p>

            <h3>任務 2-1: 排序法演示</h3>
            <p id="m2-task-desc"><strong>📖 任務說明：</strong> 觀察「選擇排序法」如何處理這組密碼：[ 8, 5, 10, 1, 7 ]。它會一輪一輪地找出「未排序」中最小的數字，放到「已排序」的末端。</p>
            <div id="m2-viz-container" class="data-container">
                </div>
            <button class="btn" id="btn-m2-start" onclick="m2_startVisualization()">開始演示 ▶️</button>
            <button class="btn btn-pause" id="btn-m2-pause" onclick="m2_togglePause()" disabled>暫停 ⏸️</button>
            <button class="btn btn-hint" id="btn-m2-new-example" onclick="m2_generate_new_example()">換一組數字 🎲</button>


            <h3 style="margin-top: 30px;">任務 2-2: 修復 Scratch 程式</h3>
            <p><strong>📖 任務說明：</strong> 這是「選擇排序法」中「找出最小值位置」的關鍵程式。但它好像壞了！請找出 <strong>(?)</strong> 應該填入什麼？</p>
            
            <div class="scratch-puzzle-container">
                <div class="scratch-stack">
                    <div class="scratch-block scratch-block-data">
                        設 [最小值位置] 為 <span class="scratch-inline-input">1</span>
                    </div>
                    <div class="scratch-block scratch-block-data">
                        設 [資料位置] 為 <span class="scratch-inline-input">2</span>
                    </div>
                    <div class="scratch-block scratch-block-control">
                        重複 <span class="scratch-inline-input">4</span> 次
                    </div>
                    <div class="scratch-stack"> <div class="scratch-block scratch-block-control">
                            如果
                            <div class="scratch-block scratch-block-operator" style="display:inline-flex; align-items: center; padding: 5px;">
                                <span class="scratch-inline-input">(原始資料 的 第 <div class="scratch-block scratch-block-data" style="margin: 0 3px;">資料位置</div> 項)</span>
                                &lt;
                                <span class="scratch-inline-input">(原始資料 的 第 
                                    <select id="m2-quiz-select" class="scratch-quiz-select">
                                        <option value="">(?)</option>
                                        <option value="資料位置">資料位置</option>
                                        <option value="最小值位置">最小值位置</option>
                                        <option value="1">1</option>
                                    </select>
                                項)</span>
                            </div>
                            那麼
                        </div>
                        <div class="scratch-stack"> <div class="scratch-block scratch-block-data">
                                設 [最小值位置] 為 <div class="scratch-block scratch-block-data" style="display:inline-block; margin: 0 3px;">資料位置</div>
                            </div>
                        </div>
                    </div>
                    <div class="scratch-block scratch-block-data" style="margin-top: 5px;">
                        改變 [資料位置] <span class="scratch-inline-input">1</span>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-check" onclick="m2_checkQuiz()">檢查答案</button>
            <button class="btn btn-hint" onclick="m2_showHint()">需要提示嗎？💡</button>
            <div id="m2-feedback" class="feedback"></div>
            <button class="btn btn-next" onclick="showMission('mission-3')" style="display:none;" id="btn-m2-next">前往 Mission 3 ➡️</button>
        </section>

        <section id="mission-3" class="mission">
            <h2>Mission 3: 鎖定目標 <span>(循序/二元搜尋法)</span></h2>
            <p class="mission-intro">
                <strong>教官：</strong> 「情報排好序了，現在我們要快速找出目標！不同的搜尋方式，效率天差地遠。體驗看看吧！」
            </p>

            <h3>任務 3-1: 循序搜尋法</h3>
            <p id="m3-seq-task-desc"><strong>📖 任務說明：</strong> ...</p>
            <div id="m3-seq-container" class="data-container">
                </div>
            <p>你已比較了 <strong id="m3-seq-count">0</strong> 次。</p>
            <button class="btn btn-reset" onclick="m3_resetSequential()">重設此任務</button>
            <div id="m3-seq-feedback" class="feedback"></div>

            <h3 style="margin-top: 30px;">任務 3-2: 二元搜尋法</h3>
            <p id="m3-bin-task-desc"><strong>📖 任務說明：</strong> ...</p>
            <div id="m3-bin-container" class="data-container">
                </div>
            <div id="m3-bin-guide">
                </div>
            <button class="btn btn-reset" onclick="m3_resetBinary()">重設此任務</button>
            <div id="m3-bin-feedback" class="feedback"></div>
            
            <hr style="margin-top: 30px;">
            <div style="text-align: center;">
                <button class="btn btn-hint" id="btn-m3-new-example" onclick="m3_generate_new_example()">換個新任務 🎲</button>
            </div>
            
            <button class="btn btn-next" onclick="showMission('mission-4')" style="display:none;" id="btn-m3-next">前往最終試煉 ➡️</button>
        </section>

        <section id="mission-4" class="mission">
            <h2>Mission 4: 最終試煉 <span>(分組合作 - 模擬)</span></h2>
            <p class="mission-intro">
                <strong>教官：</strong> 「這是你的畢業考！在真實情境中，排序和搜尋是連貫的。你必須和你的『夥伴』合作解開金庫。由於你的夥伴今天請假... 你得一人分飾兩角！」
            </p>
            <p><strong>📖 任務說明：</strong> 
                <br> <strong>Part 1 (排序)：</strong> 系統會給你一組混亂的密碼。請「點擊」數字，將它們從小到大排序。
                <br> <strong>Part 2 (搜尋)：</strong> 排序完成後，系統會給你一個「目標密碼」，請使用「二元搜尋法」找出它。
            </p>
            
            <h3>Part 1: 排序密碼</h3>
            <div id="m4-sort-pool" class="data-container"></div>
            <p><strong>你的排序結果 (點擊上方數字來排序)：</strong></p>
            <div id="m4-sort-result" class="data-container" style="min-height: 70px; background: #f9f9f9; border: 1px dashed #ccc;"></div>
            <button class="btn btn-check" onclick="m4_checkSort()">確認排序</button>
            <button class="btn btn-hint" onclick="m4_showHint()">排序提示💡</button>
            <div id="m4-sort-feedback" class="feedback"></div>

            <div id="m4-part2" style="display:none;">
                <h3 style="margin-top: 30px;">Part 2: 二元搜尋</h3>
                <p><strong>📖 任務說明：</strong> 排序完成！你的夥伴（系統）告訴你，目標密碼是 <strong id="m4-target-num"></strong>。請用「二元搜尋法」在你的排序結果中找出它！</p>
                <div id="m4-bin-container" class="data-container">
                    </div>
                <div id="m4-bin-guide">
                    </div>
                <div id="m4-bin-feedback" class="feedback"></div>
            </div>
            
            <div id="m4-final-feedback" class="feedback" style="text-align:center; font-size: 1.5rem; background: #dff0d8; color: #3c763d;">
                </div>
            
        </section>

    </main>

    <footer>
        <p>「演算法特務學院」 - 數位學習模組 Demo (v4)<br>
        靈感來源：翰林版八年級資訊科技 (108課綱) 第六章</p>
    </footer>

    <script>
        // --- 全局工具 ---
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // [v4 新增] 隨機陣列產生器
        function generateRandomArray(size = 5, min = 1, max = 20) {
            let arr = [];
            let s = new Set();
            while(s.size < size) {
                s.add(Math.floor(Math.random() * (max - min + 1)) + min);
            }
            return Array.from(s);
        }
        
        // --- 全局導航 ---
        function showMission(missionId) {
            // 隱藏所有任務
            document.querySelectorAll('.mission').forEach(m => {
                m.style.display = 'none';
            });
            // 顯示指定任務
            const targetMission = document.getElementById(missionId);
            if (targetMission) {
                targetMission.style.display = 'block';
            }
        }
        
        // 頁面載入時，預設顯示任務1
        document.addEventListener('DOMContentLoaded', () => {
            showMission('mission-1');
            m1_init();
            m2_init();
            m3_init();
            m4_init();
        });

        // --- 任務 1: 拖曳排序 (蛋炒飯) ---
        let m1_draggedItem = null;
        const m1_correctOrder = ["step-1", "step-2", "step-3", "step-4", "step-5", "step-6", "step-7"];

        function m1_init() {
            const pool = document.getElementById('item-pool');
            const zone = document.getElementById('drop-zone');
            zone.innerHTML = '';
            m1_correctOrder.forEach(id => {
                const item = document.getElementById(id);
                if (item) pool.appendChild(item);
            });
            document.querySelectorAll('.drag-item').forEach(item => item.classList.remove('hint-glow'));
            document.getElementById('m1-feedback').style.display = 'none';
            document.getElementById('btn-m1-next').style.display = 'none';
        }

        function m1_handleDragStart(e) { m1_draggedItem = e.target; }

        function m1_handleDrop(e) {
            e.preventDefault();
            const dropZone = e.target.closest('#drop-zone');
            if (dropZone && m1_draggedItem) {
                dropZone.appendChild(m1_draggedItem);
                m1_draggedItem = null;
            }
        }

        function m1_checkOrder() {
            const dropZone = document.getElementById('drop-zone');
            const items = dropZone.querySelectorAll('.drag-item');
            const feedback = document.getElementById('m1-feedback');
            
            let userOrder = Array.from(items).map(item => item.id);
            
            if (JSON.stringify(userOrder) === JSON.stringify(m1_correctOrder)) {
                feedback.textContent = '🎉 完美！看來你很有當特務的天賦！蛋炒飯... 啊不是，能量飲完成了！';
                feedback.className = 'feedback success';
                document.getElementById('btn-m1-next').style.display = 'inline-block';
            } else {
                feedback.textContent = '❌ 步驟錯誤！這個味道...不太對勁。再試一次！(或者按提示按鈕)';
                feedback.className = 'feedback error';
            }
            feedback.style.display = 'block';
        }

        function m1_showHint() {
            const dropZone = document.getElementById('drop-zone');
            const itemsInZone = dropZone.querySelectorAll('.drag-item');
            const nextStepIndex = itemsInZone.length;
            const feedback = document.getElementById('m1-feedback');
            
            document.querySelectorAll('.drag-item').forEach(item => item.classList.remove('hint-glow'));

            if (nextStepIndex >= m1_correctOrder.length) {
                feedback.textContent = '💡 你已經把所有步驟都放進去了，檢查一下順序吧！';
                feedback.className = 'feedback hint';
                feedback.style.display = 'block';
                return;
            }
            
            const nextStepId = m1_correctOrder[nextStepIndex];
            const nextStepElement = document.getElementById(nextStepId);
            
            let hintText = '';
            switch(nextStepId) {
                case 'step-1': hintText = '提示：第一步當然是... 先倒油！'; break;
                case 'step-2': hintText = '提示：油倒了，接下來要... 加熱！'; break;
                case 'step-3': hintText = '提示：油熱了，該放什麼下去了？ (蛋)'; break;
                case 'step-4': hintText = '提示：蛋下鍋了，要快點... 攪拌！'; break;
                case 'step-5': hintText = '提示：蛋熟了，主角... 米飯登場！'; break;
                case 'step-6': hintText = '提示：飯放進去了，要把它... 炒散！'; break;
                case 'step-7': hintText = '提示：最後一步，讓它變好吃... 調味！'; break;
            }

            feedback.textContent = hintText;
            feedback.className = 'feedback hint';
            feedback.style.display = 'block';

            if (nextStepElement && nextStepElement.parentElement.id === 'item-pool') {
                nextStepElement.classList.add('hint-glow');
            }
        }

        // --- 任務 2: 選擇排序法 (v4 暫停修復 / 更多範例) ---
        let m2_data = [8, 5, 10, 1, 7];
        let m2_viz_container = document.getElementById('m2-viz-container');
        let m2_isPaused = false;
        let m2_pausePromiseResolver = null;
        let m2_isRunning = false;

        // [v4 修復] 可暫停的 sleep 函式
        async function m2_pausableSleep(ms) {
            await sleep(ms); // 正常的延遲
            if (m2_isPaused) {
                // 如果是暫停狀態，建立一個 Promise 並等待它被 resolve
                await new Promise(resolve => {
                    m2_pausePromiseResolver = resolve;
                });
            }
        }

        // [v4 修復] 暫停/繼續 切換
        function m2_togglePause() {
            if (!m2_isRunning) return; // 沒在跑，按了也沒用
            
            m2_isPaused = !m2_isPaused;
            const pauseBtn = document.getElementById('btn-m2-pause');
            
            if (m2_isPaused) {
                pauseBtn.textContent = '繼續 ▶️';
            } else {
                pauseBtn.textContent = '暫停 ⏸️';
                if (m2_pausePromiseResolver) {
                    // 如果 m2_pausableSleep 正在等待，就呼叫它的 resolve() 讓它繼續
                    m2_pausePromiseResolver();
                    m2_pausePromiseResolver = null;
                }
            }
        }

        function m2_init() {
            m2_generate_new_example(true); // 初始載入預設範例
            document.getElementById('m2-feedback').style.display = 'none';
            document.getElementById('btn-m2-next').style.display = 'none';
            document.getElementById('m2-quiz-select').value = '';
        }

        // [v4 新增] 產生新範例
        function m2_generate_new_example(isDefault = false) {
            if (m2_isRunning) return; // 動畫中，不給換
            
            if (isDefault) {
                m2_data = [8, 5, 10, 1, 7];
            } else {
                m2_data = generateRandomArray(5, 1, 20);
            }
            
            document.getElementById('m2-task-desc').innerHTML = `<strong>📖 任務說明：</strong> 觀察「選擇排序法」如何處理這組密碼：[ ${m2_data.join(', ')} ]。它會一輪一輪地找出「未排序」中最小的數字，放到「已排序」的末端。`;
            m2_resetVisualization();
        }
        
        // m2_resetVisualization 只負責繪製當前的 m2_data
        function m2_resetVisualization() {
            m2_viz_container.innerHTML = '';
            m2_data.forEach(val => {
                let box = document.createElement('div');
                box.className = 'data-box';
                box.textContent = val;
                m2_viz_container.appendChild(box);
            });
            // 重置狀態
            m2_isRunning = false;
            m2_isPaused = false;
            if (m2_pausePromiseResolver) {
                m2_pausePromiseResolver();
                m2_pausePromiseResolver = null;
            }
            document.getElementById('btn-m2-pause').textContent = '暫停 ⏸️';
            document.getElementById('btn-m2-pause').disabled = true;
            document.getElementById('btn-m2-start').disabled = false;
            document.getElementById('btn-m2-new-example').disabled = false;
        }
        
        async function m2_startVisualization() {
            if (m2_isRunning) return; // 防止重複執行
            m2_isRunning = true;
            document.getElementById('btn-m2-pause').disabled = false;
            document.getElementById('btn-m2-start').disabled = true;
            document.getElementById('btn-m2-new-example').disabled = true;
            
            // 重新繪製，確保是乾淨的狀態
            m2_viz_container.innerHTML = '';
            m2_data.forEach(val => {
                let box = document.createElement('div');
                box.className = 'data-box';
                box.textContent = val;
                m2_viz_container.appendChild(box);
            });
            let boxes = m2_viz_container.querySelectorAll('.data-box');
            let n = boxes.length;

            try {
                for (let i = 0; i < n - 1; i++) {
                    let minIdx = i;
                    boxes[i].classList.add('highlight-swap'); // 標記當前比較的基準
                    await m2_pausableSleep(800);

                    // 找到未排序部分中的最小值
                    for (let j = i + 1; j < n; j++) {
                        boxes[j].classList.add('highlight-min'); // 標記正在檢查的
                        await m2_pausableSleep(500);
                        if (parseInt(boxes[j].textContent) < parseInt(boxes[minIdx].textContent)) {
                            boxes[minIdx].classList.remove('highlight-min', 'highlight-swap');
                            minIdx = j;
                            boxes[minIdx].classList.add('highlight-min'); // 標記新的最小值
                        } else {
                            boxes[j].classList.remove('highlight-min');
                        }
                    }
                    
                    await m2_pausableSleep(800);

                    // 交換
                    let temp = boxes[i].textContent;
                    boxes[i].textContent = boxes[minIdx].textContent;
                    boxes[minIdx].textContent = temp;

                    // 清除樣式
                    boxes.forEach(box => box.classList.remove('highlight-min', 'highlight-swap'));
                    boxes[i].classList.add('sorted'); // 標記已排序
                }
                boxes[n - 1].classList.add('sorted');
            } catch (e) {
                console.error("Animation stopped:", e);
            } finally {
                // 演示結束
                m2_isRunning = false;
                m2_isPaused = false;
                document.getElementById('btn-m2-pause').textContent = '暫停 ⏸️';
                document.getElementById('btn-m2-pause').disabled = true;
                document.getElementById('btn-m2-start').disabled = false;
                document.getElementById('btn-m2-new-example').disabled = false;
            }
        }

        function m2_checkQuiz() {
            const answer = document.getElementById('m2-quiz-select').value;
            const feedback = document.getElementById('m2-feedback');
            if (answer === '最小值位置') {
                feedback.textContent = '🎉 正確！就是要跟當前紀錄的「最小值位置」上的數字比較。程式修復完畢！';
                feedback.className = 'feedback success';
                document.getElementById('btn-m2-next').style.display = 'inline-block';
            } else {
                feedback.textContent = '❌ 錯誤！再想想看，或按提示鈕。';
                feedback.className = 'feedback error';
            }
            feedback.style.display = 'block';
        }

        function m2_showHint() {
            const feedback = document.getElementById('m2-feedback');
            feedback.textContent = '💡 提示：我們要比較的是「目前正在檢查的項目」(由 [資料位置] 控制) 和「我們*暫時*找到的最小項目」(由 [最小值位置] 控制)。所以 (?) 應該是...？';
            feedback.className = 'feedback hint';
            feedback.style.display = 'block';
        }

        // --- 任務 3: 搜尋 (v4 更多範例) ---
        let m3_seq_data = [];
        let m3_seq_target = 0;
        let m3_seq_count = 0;
        let m3_seq_found = false;

        let m3_bin_data = [];
        let m3_bin_target = 0;
        
        function m3_init() {
            m3_generate_new_example(true); // 載入第一個範例
            document.getElementById('btn-m3-next').style.display = 'none';
        }

        // [v4 新增] 產生新範例
        function m3_generate_new_example(isDefault = false) {
            if (isDefault) {
                // 循序
                m3_seq_data = [8, 5, 10, 1, 7];
                m3_seq_target = 10;
                // 二元
                m3_bin_data = [1, 5, 7, 8, 10];
                m3_bin_target = 10;
            } else {
                // 循序
                m3_seq_data = generateRandomArray(5, 1, 20);
                m3_seq_target = m3_seq_data[Math.floor(Math.random() * m3_seq_data.length)]; // 確保目標存在
                // 二元
                let temp_bin = generateRandomArray(5, 1, 20);
                m3_bin_data = [...temp_bin].sort((a,b) => a-b);
                m3_bin_target = m3_bin_data[Math.floor(Math.random() * m3_bin_data.length)]; // 確保目標存在
            }

            // 更新任務說明
            document.getElementById('m3-seq-task-desc').innerHTML = `<strong>📖 任務說明：</strong> 在這堆 <strong>未排序</strong> 的彈藥箱 [ ${m3_seq_data.join(', ')} ] 中，找出 <strong>${m3_seq_target}號</strong> 彈藥。你必須 *從左到右* 依序點擊檢查！`;
            document.getElementById('m3-bin-task-desc').innerHTML = `<strong>📖 任務說明：</strong> 這次彈藥箱 <strong>已排序</strong> [ ${m3_bin_data.join(', ')} ]。我們要找出 <strong>${m3_bin_target}號</strong> 彈藥。請跟隨系統的提示！`;

            // 重設兩個任務
            m3_resetSequential();
            m3_resetBinary();
            document.getElementById('btn-m3-next').style.display = 'none';
        }

        // 3-1 循序搜尋
        function m3_resetSequential() {
            const container = document.getElementById('m3-seq-container');
            container.innerHTML = '';
            m3_seq_count = 0;
            m3_seq_found = false;
            document.getElementById('m3-seq-count').textContent = '0';
            document.getElementById('m3-seq-feedback').style.display = 'none';
            
            m3_seq_data.forEach((val, index) => {
                let box = document.createElement('div');
                box.className = 'data-box search-target';
                box.textContent = val;
                box.onclick = () => m3_checkSequential(box, val, index);
                container.appendChild(box);
            });
        }
        
        function m3_checkSequential(box, val, index) {
            if (m3_seq_found) return; 
            
            const feedback = document.getElementById('m3-seq-feedback');
            if (index !== m3_seq_count) {
                feedback.textContent = `❌ 點錯順序了！「循序」搜尋的SOP，就是從*最左邊*一個一個來。請點擊第 ${m3_seq_count + 1} 個方塊。`;
                feedback.className = 'feedback error';
                feedback.style.display = 'block';
                return;
            }

            m3_seq_count++;
            document.getElementById('m3-seq-count').textContent = m3_seq_count;
            box.classList.add('highlight-swap'); 

            if (val === m3_seq_target) {
                m3_seq_found = true;
                feedback.textContent = `🎉 找到了！目標是 ${val}。你總共比較了 ${m3_seq_count} 次。`;
                feedback.className = 'feedback success';
                box.classList.add('sorted');
                // 檢查是否兩個任務都完成了
                if (document.getElementById('m3-bin-feedback').classList.contains('success')) {
                    document.getElementById('btn-m3-next').style.display = 'inline-block';
                }
            } else {
                feedback.textContent = `第 ${m3_seq_count} 次： ${val} 不是目標... 繼續找下一個。`;
                feedback.className = 'feedback hint'; 
            }
            feedback.style.display = 'block';
        }

        // 3-2 二元搜尋
        function m3_resetBinary() {
            const container = document.getElementById('m3-bin-container');
            container.innerHTML = '';
            m3_bin_data.forEach(val => {
                let box = document.createElement('div');
                box.className = 'data-box';
                box.textContent = val;
                container.appendChild(box);
            });
            document.getElementById('m3-bin-feedback').style.display = 'none';
            document.getElementById('m3-bin-feedback').classList.remove('success');
            m3_startBinarySearch(0, m3_bin_data.length - 1, 0); 
        }

        function m3_startBinarySearch(low, high, count) { 
            const guide = document.getElementById('m3-bin-guide');
            const feedback = document.getElementById('m3-bin-feedback');
            const boxes = document.querySelectorAll('#m3-bin-container .data-box');
            
            boxes.forEach((box, i) => {
                if (i >= low && i <= high) {
                    box.classList.remove('disabled');
                } else {
                    box.classList.add('disabled');
                }
            });

            if (low > high) {
                feedback.textContent = '❌ 咦？範圍內找不到了！任務失敗。';
                feedback.className = 'feedback error';
                feedback.style.display = 'block';
                return;
            }

            let mid = Math.floor((low + high) / 2);
            let midVal = m3_bin_data[mid];
            let newCount = count + 1; 
            
            boxes[mid].classList.add('highlight-min'); 

            guide.innerHTML = `
                <p><strong>第 ${newCount} 次比較：</strong></p>
                <p>目前搜尋範圍：索引 [${low}] 到 [${high}]。</p>
                <p>我們檢查中間位置 (索引 ${mid})，數字是 <strong>${midVal}</strong>。</p>
                <p>目標 <strong>${m3_bin_target}</strong> 比 <strong>${midVal}</strong> ...？</p>
                <button class="btn" onclick="m3_handleBinaryChoice(${low}, ${high}, ${mid}, 'less', ${newCount})">小</button>
                <button class="btn" onclick="m3_handleBinaryChoice(${low}, ${high}, ${mid}, 'equal', ${newCount})">等於</button>
                <button class="btn" onclick="m3_handleBinaryChoice(${low}, ${high}, ${mid}, 'more', ${newCount})">大</button>
            `;
        }

        function m3_handleBinaryChoice(low, high, mid, choice, count) { 
            const midVal = m3_bin_data[mid];
            const feedback = document.getElementById('m3-bin-feedback');
            const boxes = document.querySelectorAll('#m3-bin-container .data-box');
            boxes[mid].classList.remove('highlight-min');

            let correctChoice = '';
            if (m3_bin_target < midVal) correctChoice = 'less';
            else if (m3_bin_target > midVal) correctChoice = 'more';
            else correctChoice = 'equal';

            if (choice !== correctChoice) {
                feedback.textContent = `❌ 判斷錯誤！再想一下... 我們的目標是 ${m3_bin_target}，而中間值是 ${midVal}。 ${m3_bin_target} 應該在 ${midVal} 的哪一邊呢？`;
                feedback.className = 'feedback error';
                feedback.style.display = 'block';
                m3_startBinarySearch(low, high, count - 1); 
                return;
            }

            feedback.style.display = 'none'; 

            if (choice === 'equal') {
                feedback.textContent = `🎉 找到了！目標就是 ${midVal}！總共比較了 ${count} 次。`;
                feedback.className = 'feedback success'; // 標記成功
                feedback.style.display = 'block';
                boxes[mid].classList.add('sorted');
                document.getElementById('m3-bin-guide').innerHTML = '';
                // 檢查是否兩個任務都完成了
                if (m3_seq_found) {
                    document.getElementById('btn-m3-next').style.display = 'inline-block';
                }
            } else if (choice === 'less') {
                m3_startBinarySearch(low, mid - 1, count); 
            } else if (choice === 'more') {
                m3_startBinarySearch(mid + 1, high, count);
            }
        }

        // --- 任務 4: 最終試煉 ---
        let m4_data = [];
        let m4_sorted_data = [];
        let m4_target = 0; 
        
        function m4_init() {
            const pool = document.getElementById('m4-sort-pool');
            const result = document.getElementById('m4-sort-result');
            pool.innerHTML = '';
            result.innerHTML = '';
            m4_sorted_data = [];
            
            m4_data = generateRandomArray(5, 1, 100);
            m4_target = m4_data[Math.floor(Math.random() * m4_data.length)]; 
            
            m4_data.forEach(val => {
                let box = document.createElement('div');
                box.className = 'data-box search-target';
                box.textContent = val;
                box.onclick = () => m4_addToSort(box, val);
                pool.appendChild(box);
            });
            
            document.getElementById('m4-target-num').textContent = m4_target;
            document.getElementById('m4-part2').style.display = 'none';
            document.getElementById('m4-sort-feedback').style.display = 'none';
            document.getElementById('m4-bin-feedback').style.display = 'none';
            document.getElementById('m4-final-feedback').style.display = 'none';
        }

        function m4_addToSort(box, val) {
            m4_sorted_data.push(val);
            const result = document.getElementById('m4-sort-result');
            let newBox = document.createElement('div');
            newBox.className = 'data-box';
            newBox.textContent = val;
            result.appendChild(newBox);
            box.style.display = 'none'; 
        }

        function m4_checkSort() {
            const feedback = document.getElementById('m4-sort-feedback');
            let correctSorted = [...m4_data].sort((a, b) => a - b);
            
            if (JSON.stringify(m4_sorted_data) === JSON.stringify(correctSorted)) {
                feedback.textContent = '🎉 排序正確！準備進行 Part 2！';
                feedback.className = 'feedback success';
                document.getElementById('m4-part2').style.display = 'block';
                m4_startBinarySearch(0, m4_sorted_data.length - 1, 0); 
            } else {
                feedback.textContent = '❌ 排序錯誤！請重設並再試一次。(或按提示)';
                feedback.className = 'feedback error';
                setTimeout(() => { 
                    m4_init();
                }, 1500);
            }
            feedback.style.display = 'block';
        }

        function m4_showHint() {
            const feedback = document.getElementById('m4-sort-feedback');
            let correctSorted = [...m4_data].sort((a, b) => a - b);
            if(m4_sorted_data.length >= correctSorted.length) {
                feedback.textContent = '💡 你已經選完所有數字了，按「確認排序」吧！';
                feedback.className = 'feedback hint';
                feedback.style.display = 'block';
                return;
            }
            let nextNum = correctSorted[m4_sorted_data.length];
            feedback.textContent = '💡 提示：『從小排到大』，你選的下一個數字，應該是剩下數字中最小的... 也就是 ' + nextNum + '。';
            feedback.className = 'feedback hint';
            feedback.style.display = 'block';
        }
        
        function m4_startBinarySearch(low, high, count) { 
            const guide = document.getElementById('m4-bin-guide');
            const feedback = document.getElementById('m4-bin-feedback');
            const container = document.getElementById('m4-bin-container');
            
            container.innerHTML = '';
            m4_sorted_data.forEach(val => {
                let box = document.createElement('div');
                box.className = 'data-box';
                box.textContent = val;
                container.appendChild(box);
            });
            const boxes = container.querySelectorAll('.data-box');

            boxes.forEach((box, i) => {
                if (i >= low && i <= high) box.classList.remove('disabled');
                else box.classList.add('disabled');
            });

            if (low > high) {
                feedback.textContent = '❌ 咦？你是不是搞錯了？找不到了...';
                feedback.className = 'feedback error';
                feedback.style.display = 'block';
                return;
            }

            let mid = Math.floor((low + high) / 2);
            let midVal = m4_sorted_data[mid];
            let newCount = count + 1; 
            
            boxes[mid].classList.add('highlight-min');

            guide.innerHTML = `
                <p><strong>第 ${newCount} 次比較：</strong></p>
                <p>搜尋範圍 [${low}] 到 [${high}]。中間 (索引 ${mid}) 是 <strong>${midVal}</strong>。</p>
                <p>目標 <strong>${m4_target}</strong> 和 <strong>${midVal}</strong> 相比？</p>
                <button class="btn" onclick="m4_handleBinaryChoice(${low}, ${high}, ${mid}, 'less', ${newCount})">小</button>
                <button class="btn" onclick="m4_handleBinaryChoice(${low}, ${high}, ${mid}, 'equal', ${newCount})">等於</button>
                <button class="btn" onclick="m4_handleBinaryChoice(${low}, ${high}, ${mid}, 'more', ${newCount})">大</button>
            `;
        }

        function m4_handleBinaryChoice(low, high, mid, choice, count) { 
            const midVal = m4_sorted_data[mid];
            const feedback = document.getElementById('m4-bin-feedback');
            
            let correctChoice = '';
            if (m4_target < midVal) correctChoice = 'less';
            else if (m4_target > midVal) correctChoice = 'more';
            else correctChoice = 'equal';

            if (choice !== correctChoice) {
                feedback.textContent = `❌ 判斷錯誤！再想一下... 我們的目標是 ${m4_target}，而中間值是 ${midVal}。 ${m4_target} 應該在 ${midVal} 的哪一邊呢？`;
                feedback.className = 'feedback error';
                feedback.style.display = 'block';
                m4_startBinarySearch(low, high, count - 1); 
                return;
            }
            
            feedback.style.display = 'none';

            if (choice === 'equal') {
                document.getElementById('m4-final-feedback').innerHTML = `
                🏆 任務完成！ 🏆
                <p>恭喜你，探員！你已經掌握了演算法的核心！你已順利畢業！</p>
                <button class="btn btn-next" onclick="location.reload()">重新挑戰學院</button>
                `;
                document.getElementById('m4-final-feedback').style.display = 'block';
                document.querySelector(`#m4-bin-container .data-box:nth-child(${mid + 1})`).classList.add('sorted');
                document.getElementById('m4-bin-guide').innerHTML = '';
            } else if (choice === 'less') {
                m4_startBinarySearch(low, mid - 1, count);
            } else if (choice === 'more') {
                m4_startBinarySearch(mid + 1, high, count);
            }
        }

    </script>
</body>
</html>